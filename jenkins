pipeline {
  agent any

  environment {
    IMAGE = "asia-south1-docker.pkg.dev/project-anny/demo-repo/python-image:latest"
    CLUSTER = "test-cluster"
    CLUSTER_REGION = "asia-south1"
    DEPLOYMENT_NAME = "py-service"
    GOOGLE_APPLICATION_CREDENTIALS = credentials('GCP_CREDENTIALS')
  }

  stages {
    stage('Checkout Code') {
      steps {
        checkout scm
      }
    }

    stage('Docker Build') {
      steps {
        sh "docker build -t ${IMAGE} ."
      }
    }

    stage('Push to Artifact Registry') {
      steps {
        sh "gcloud auth activate-service-account --key-file=${GOOGLE_APPLICATION_CREDENTIALS}"
        sh "gcloud config set project project-anny"
        sh "gcloud auth configure-docker ${IMAGE.split('/')[0]}"
        sh "docker push ${IMAGE}"
      }
    }

    stage('Get GKE Credentials') {
      steps {
        sh "gcloud container clusters get-credentials ${CLUSTER} --region ${CLUSTER_REGION}"
      }
    }

    stage('Deploy to GKE') {
      steps {
        sh "kubectl apply -f k8s/deployment.yaml"
        sh "kubectl apply -f k8s/service.yaml"
      }
    }
  }
}
